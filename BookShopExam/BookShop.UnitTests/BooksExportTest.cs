//Resharper disable InconsistentNaming, CheckNamespace

using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Reflection;
using System.Xml.Linq;
using BookShop;
using BookShop.Data;
using BookShop.DataProcessor;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NUnit.Framework;


[TestFixture]
public class BooksExportTest
{
    private IServiceProvider serviceProvider;
    private static Assembly CurrentAssembly;

    [SetUp]
    public void Setup()
    {
        CurrentAssembly = typeof(StartUp).Assembly;

        this.serviceProvider = ConfigureServices<BookShopContext>("BookShopContext");
    }

    [Test]
    public void ExportOldestBooks()
    {
        var context = serviceProvider.GetService<BookShopContext>();

        SeedDatabase(context);

        DateTime dateTime = DateTime.ParseExact("25/01/2017", "dd/MM/yyyy", CultureInfo.InvariantCulture);

        var actualOutputValue = Serializer.ExportOldestBooks(context, dateTime);
        var actualOutput = XDocument.Parse(actualOutputValue);

        var expectedOutputValue = "<?xml version=\"1.0\" encoding=\"utf-16\"?>\r\n<Books>\r\n<Book Pages=\"4881\">\r\n<Name>Sierra Marsh Fern</Name>\r\n<Date>03/18/2016</Date>\r\n</Book>\r\n<Book Pages=\"4786\">\r\n<Name>Little Elephantshead</Name>\r\n<Date>12/16/2014</Date>\r\n</Book>\r\n<Book Pages=\"3245\">\r\n<Name>Airplant</Name>\r\n<Date>11/24/2016</Date>\r\n </Book>\r\n<Book Pages=\"3039\">\r\n<Name>Palo Blanco</Name>\r\n<Date>06/25/2014</Date>\r\n</Book>\r\n<Book Pages=\"3013\">\r\n<Name>Hairy Torchwood</Name>\r\n<Date>01/13/2013</Date>\r\n</Book>\r\n<Book Pages=\"1870\">\r\n<Name>Bigelow's Monkeyflower</Name>\r\n<Date>11/20/2015</Date>\r\n</Book>\r\n<Book Pages=\"1238\">\r\n<Name>Ethiopian Rattlebox</Name>\r\n<Date>09/03/2014</Date>\r\n</Book>\r\n<Book Pages=\"802\">\r\n<Name>Gigantochloa</Name>\r\n<Date>08/31/2014</Date>\r\n</Book>\r\n<Book Pages=\"588\">\r\n<Name>Roble De Sierra</Name>\r\n<Date>08/25/2014</Date>\r\n</Book>\r\n<Book Pages=\"429\">\r\n<Name>Gray Dogwood</Name>\r\n<Date>04/09/2014</Date>\r\n</Book>\r\n</Books>";

        var expectedOutput = XDocument.Parse(expectedOutputValue);

        var expectedOutputXml = expectedOutput.ToString(SaveOptions.DisableFormatting);
        var actualOutputXml = actualOutput.ToString(SaveOptions.DisableFormatting);

        Assert.That(actualOutputXml, Is.EqualTo(expectedOutputXml).NoClip,
            $"{nameof(Serializer.ExportOldestBooks)} output is incorrect!");
    }

    private static void SeedDatabase(BookShopContext context)
    {
        var datasetsJson =
            "{\"Book\":[{\"Id\":1,\"Name\":\"Hairy Torchwood\",\"Genre\":3,\"Price\":41.99,\"Pages\":3013,\"PublishedOn\":\"2013-01-13T00:00:00\"},{\"Id\":2,\"Name\":\"Hayfield Tarweed\",\"Genre\":3,\"Price\":51.69,\"Pages\":3722,\"PublishedOn\":\"2017-10-24T00:00:00\"},{\"Id\":3,\"Name\":\"Pinon\",\"Genre\":1,\"Price\":14.1,\"Pages\":2258,\"PublishedOn\":\"2016-06-20T00:00:00\"},{\"Id\":4,\"Name\":\"Wideleaf Schistidium Moss\",\"Genre\":2,\"Price\":16.26,\"Pages\":1241,\"PublishedOn\":\"2015-11-05T00:00:00\"},{\"Id\":5,\"Name\":\"Featherstem Clubmoss\",\"Genre\":2,\"Price\":89.77,\"Pages\":3043,\"PublishedOn\":\"2014-08-01T00:00:00\"},{\"Id\":6,\"Name\":\"Tapertip Rush\",\"Genre\":1,\"Price\":49.34,\"Pages\":131,\"PublishedOn\":\"2015-05-28T00:00:00\"},{\"Id\":7,\"Name\":\"Australian Desert Lime\",\"Genre\":1,\"Price\":42.29,\"Pages\":1719,\"PublishedOn\":\"2019-05-07T00:00:00\"},{\"Id\":8,\"Name\":\"Silverweed\",\"Genre\":2,\"Price\":88.66,\"Pages\":4328,\"PublishedOn\":\"2012-12-20T00:00:00\"},{\"Id\":9,\"Name\":\"Maui Woodfern\",\"Genre\":2,\"Price\":78.42,\"Pages\":218,\"PublishedOn\":\"2015-05-10T00:00:00\"},{\"Id\":10,\"Name\":\"Roundheaded Leek\",\"Genre\":2,\"Price\":10.41,\"Pages\":2296,\"PublishedOn\":\"2017-01-17T00:00:00\"},{\"Id\":11,\"Name\":\"Pyramid Bugle\",\"Genre\":2,\"Price\":56.74,\"Pages\":2286,\"PublishedOn\":\"2013-10-31T00:00:00\"},{\"Id\":12,\"Name\":\"Spring Thistle\",\"Genre\":3,\"Price\":29.62,\"Pages\":4161,\"PublishedOn\":\"2019-11-09T00:00:00\"},{\"Id\":13,\"Name\":\"Seepweed\",\"Genre\":3,\"Price\":54.05,\"Pages\":2031,\"PublishedOn\":\"2019-01-31T00:00:00\"},{\"Id\":14,\"Name\":\"Singlestem Leather-root\",\"Genre\":2,\"Price\":25.11,\"Pages\":407,\"PublishedOn\":\"2018-09-12T00:00:00\"},{\"Id\":15,\"Name\":\"Gray Dogwood\",\"Genre\":3,\"Price\":17.25,\"Pages\":429,\"PublishedOn\":\"2014-04-09T00:00:00\"},{\"Id\":16,\"Name\":\"Shagbark Hickory\",\"Genre\":1,\"Price\":64.49,\"Pages\":308,\"PublishedOn\":\"2019-11-13T00:00:00\"},{\"Id\":17,\"Name\":\"Ochna\",\"Genre\":2,\"Price\":58.87,\"Pages\":1731,\"PublishedOn\":\"2015-04-02T00:00:00\"},{\"Id\":18,\"Name\":\"Twayblade\",\"Genre\":3,\"Price\":78.31,\"Pages\":620,\"PublishedOn\":\"2019-06-18T00:00:00\"},{\"Id\":19,\"Name\":\"Ocellularia Lichen\",\"Genre\":3,\"Price\":80.61,\"Pages\":1599,\"PublishedOn\":\"2018-01-15T00:00:00\"},{\"Id\":20,\"Name\":\"Sierra Marsh Fern\",\"Genre\":3,\"Price\":42.55,\"Pages\":4881,\"PublishedOn\":\"2016-03-18T00:00:00\"},{\"Id\":21,\"Name\":\"Sky Mousetail\",\"Genre\":1,\"Price\":13.14,\"Pages\":2877,\"PublishedOn\":\"2019-07-29T00:00:00\"},{\"Id\":22,\"Name\":\"Wisconsin Rim Lichen\",\"Genre\":2,\"Price\":57.79,\"Pages\":2414,\"PublishedOn\":\"2017-08-08T00:00:00\"},{\"Id\":23,\"Name\":\"Sphinctrina Lichen\",\"Genre\":1,\"Price\":67.15,\"Pages\":4795,\"PublishedOn\":\"2018-12-27T00:00:00\"},{\"Id\":24,\"Name\":\"Rough Maidenhair\",\"Genre\":2,\"Price\":52.63,\"Pages\":2791,\"PublishedOn\":\"2017-09-03T00:00:00\"},{\"Id\":25,\"Name\":\"Bigelow's Monkeyflower\",\"Genre\":3,\"Price\":19.34,\"Pages\":1870,\"PublishedOn\":\"2015-11-20T00:00:00\"},{\"Id\":26,\"Name\":\"Stebbins' Desertparsley\",\"Genre\":1,\"Price\":34.18,\"Pages\":3443,\"PublishedOn\":\"2014-11-29T00:00:00\"},{\"Id\":27,\"Name\":\"Psoralea Globemallow\",\"Genre\":3,\"Price\":51.18,\"Pages\":165,\"PublishedOn\":\"2013-03-30T00:00:00\"},{\"Id\":28,\"Name\":\"Arizona Century Plant\",\"Genre\":1,\"Price\":43.53,\"Pages\":1771,\"PublishedOn\":\"2017-01-05T00:00:00\"},{\"Id\":29,\"Name\":\"Jamaican Broom\",\"Genre\":1,\"Price\":50.72,\"Pages\":274,\"PublishedOn\":\"2014-08-28T00:00:00\"},{\"Id\":30,\"Name\":\"Borrego Milkvetch\",\"Genre\":2,\"Price\":60.41,\"Pages\":1281,\"PublishedOn\":\"2017-08-15T00:00:00\"},{\"Id\":31,\"Name\":\"Earlyleaf Brome\",\"Genre\":3,\"Price\":63.66,\"Pages\":1379,\"PublishedOn\":\"2019-01-09T00:00:00\"},{\"Id\":32,\"Name\":\"Twoflower Melicgrass\",\"Genre\":2,\"Price\":29.06,\"Pages\":2855,\"PublishedOn\":\"2014-01-09T00:00:00\"},{\"Id\":33,\"Name\":\"Rayless Alkali Aster\",\"Genre\":2,\"Price\":98.99,\"Pages\":137,\"PublishedOn\":\"2013-07-31T00:00:00\"},{\"Id\":34,\"Name\":\"Small Floating Mannagrass\",\"Genre\":1,\"Price\":49.15,\"Pages\":3569,\"PublishedOn\":\"2013-05-16T00:00:00\"},{\"Id\":35,\"Name\":\"Texas Lady's Tresses\",\"Genre\":3,\"Price\":16.34,\"Pages\":4170,\"PublishedOn\":\"2017-12-08T00:00:00\"},{\"Id\":36,\"Name\":\"Winter Vetch\",\"Genre\":2,\"Price\":19.51,\"Pages\":2693,\"PublishedOn\":\"2013-11-13T00:00:00\"},{\"Id\":37,\"Name\":\"Desert Combleaf\",\"Genre\":3,\"Price\":98.72,\"Pages\":2264,\"PublishedOn\":\"2018-03-29T00:00:00\"},{\"Id\":38,\"Name\":\"Candy Barrelcactus\",\"Genre\":1,\"Price\":51.78,\"Pages\":2040,\"PublishedOn\":\"2014-05-03T00:00:00\"},{\"Id\":39,\"Name\":\"Lindley's Clarkia\",\"Genre\":2,\"Price\":0.87,\"Pages\":2293,\"PublishedOn\":\"2015-12-03T00:00:00\"},{\"Id\":40,\"Name\":\"Lapland Poppy\",\"Genre\":1,\"Price\":14.54,\"Pages\":198,\"PublishedOn\":\"2016-04-02T00:00:00\"},{\"Id\":41,\"Name\":\"Macoun's Woodroot\",\"Genre\":3,\"Price\":17.91,\"Pages\":224,\"PublishedOn\":\"2018-07-28T00:00:00\"},{\"Id\":42,\"Name\":\"Airplant\",\"Genre\":3,\"Price\":30.47,\"Pages\":3245,\"PublishedOn\":\"2016-11-24T00:00:00\"},{\"Id\":43,\"Name\":\"Black Bogrush\",\"Genre\":1,\"Price\":3.48,\"Pages\":3620,\"PublishedOn\":\"2013-11-18T00:00:00\"},{\"Id\":44,\"Name\":\"Great Basin Woollystar\",\"Genre\":2,\"Price\":31.74,\"Pages\":415,\"PublishedOn\":\"2014-02-10T00:00:00\"},{\"Id\":45,\"Name\":\"Woodland Spurge\",\"Genre\":1,\"Price\":80.52,\"Pages\":584,\"PublishedOn\":\"2014-05-09T00:00:00\"},{\"Id\":46,\"Name\":\"Gigantochloa\",\"Genre\":3,\"Price\":65.81,\"Pages\":802,\"PublishedOn\":\"2014-08-31T00:00:00\"},{\"Id\":47,\"Name\":\"Drummond's Clematis\",\"Genre\":1,\"Price\":43.43,\"Pages\":1698,\"PublishedOn\":\"2015-01-26T00:00:00\"},{\"Id\":48,\"Name\":\"Shingle Oak\",\"Genre\":2,\"Price\":17.85,\"Pages\":1816,\"PublishedOn\":\"2016-04-29T00:00:00\"},{\"Id\":49,\"Name\":\"Woollyleaf Bur Ragweed\",\"Genre\":3,\"Price\":3.9,\"Pages\":1641,\"PublishedOn\":\"2018-01-24T00:00:00\"},{\"Id\":50,\"Name\":\"Mojave Linanthus\",\"Genre\":2,\"Price\":82.29,\"Pages\":3625,\"PublishedOn\":\"2014-11-09T00:00:00\"},{\"Id\":51,\"Name\":\"Common Netbush\",\"Genre\":2,\"Price\":77.83,\"Pages\":2179,\"PublishedOn\":\"2013-01-26T00:00:00\"},{\"Id\":52,\"Name\":\"Ethiopian Rattlebox\",\"Genre\":3,\"Price\":87.96,\"Pages\":1238,\"PublishedOn\":\"2014-09-03T00:00:00\"},{\"Id\":53,\"Name\":\"Pineapple\",\"Genre\":2,\"Price\":36.57,\"Pages\":117,\"PublishedOn\":\"2018-10-30T00:00:00\"},{\"Id\":54,\"Name\":\"Roble De Sierra\",\"Genre\":3,\"Price\":53.68,\"Pages\":588,\"PublishedOn\":\"2014-08-25T00:00:00\"},{\"Id\":55,\"Name\":\"Dicranodontium Moss\",\"Genre\":1,\"Price\":38.01,\"Pages\":2258,\"PublishedOn\":\"2014-10-07T00:00:00\"},{\"Id\":56,\"Name\":\"Jolon Clarkia\",\"Genre\":2,\"Price\":40.6,\"Pages\":4076,\"PublishedOn\":\"2014-06-13T00:00:00\"},{\"Id\":57,\"Name\":\"Candle Tree\",\"Genre\":1,\"Price\":9.0,\"Pages\":3917,\"PublishedOn\":\"2016-06-02T00:00:00\"},{\"Id\":58,\"Name\":\"Java Grass\",\"Genre\":1,\"Price\":62.49,\"Pages\":1123,\"PublishedOn\":\"2015-01-10T00:00:00\"},{\"Id\":59,\"Name\":\"Jasmine Nightshade\",\"Genre\":1,\"Price\":84.89,\"Pages\":900,\"PublishedOn\":\"2016-05-12T00:00:00\"},{\"Id\":60,\"Name\":\"Spanish Heath\",\"Genre\":2,\"Price\":1.13,\"Pages\":4450,\"PublishedOn\":\"2015-08-28T00:00:00\"},{\"Id\":61,\"Name\":\"Chesapeake Panicgrass\",\"Genre\":1,\"Price\":96.63,\"Pages\":2794,\"PublishedOn\":\"2017-06-14T00:00:00\"},{\"Id\":62,\"Name\":\"Little Elephantshead\",\"Genre\":3,\"Price\":41.81,\"Pages\":4786,\"PublishedOn\":\"2014-12-16T00:00:00\"},{\"Id\":63,\"Name\":\"Fringed Nutrush\",\"Genre\":1,\"Price\":96.94,\"Pages\":3491,\"PublishedOn\":\"2016-04-24T00:00:00\"},{\"Id\":64,\"Name\":\"Arrowleaf Clover\",\"Genre\":2,\"Price\":1.71,\"Pages\":2603,\"PublishedOn\":\"2016-05-27T00:00:00\"},{\"Id\":65,\"Name\":\"Spreading Beaksedge\",\"Genre\":1,\"Price\":2.43,\"Pages\":2804,\"PublishedOn\":\"2019-05-22T00:00:00\"},{\"Id\":66,\"Name\":\"Southern Pepperwort\",\"Genre\":3,\"Price\":63.48,\"Pages\":4230,\"PublishedOn\":\"2017-06-11T00:00:00\"},{\"Id\":67,\"Name\":\"Allen Fissidens Moss\",\"Genre\":2,\"Price\":78.44,\"Pages\":2825,\"PublishedOn\":\"2013-02-26T00:00:00\"},{\"Id\":68,\"Name\":\"Common Mullein\",\"Genre\":3,\"Price\":37.67,\"Pages\":4751,\"PublishedOn\":\"2018-07-03T00:00:00\"},{\"Id\":69,\"Name\":\"Palo Blanco\",\"Genre\":3,\"Price\":79.11,\"Pages\":3039,\"PublishedOn\":\"2014-06-25T00:00:00\"},{\"Id\":70,\"Name\":\"Narrowleaf Colicwood\",\"Genre\":2,\"Price\":9.09,\"Pages\":3134,\"PublishedOn\":\"2017-02-03T00:00:00\"}],\"Author\":[{\"Id\":1,\"FirstName\":\"Nataniel\",\"LastName\":\"Pembery\",\"Phone\":\"343-101-5329\",\"Email\":\"npembery5@shop-pro.jp\"},{\"Id\":2,\"FirstName\":\"Pearce\",\"LastName\":\"Gibbon\",\"Phone\":\"198-688-2310\",\"Email\":\"pgibbon1y@nytimes.com\"},{\"Id\":3,\"FirstName\":\"Jermaine\",\"LastName\":\"Alpine\",\"Phone\":\"969-639-3796\",\"Email\":\"jalpine1w@weibo.com\"},{\"Id\":4,\"FirstName\":\"Tab\",\"LastName\":\"Cockman\",\"Phone\":\"606-706-4274\",\"Email\":\"tcockman1v@shutterfly.com\"},{\"Id\":5,\"FirstName\":\"Hendrick\",\"LastName\":\"Cleminson\",\"Phone\":\"900-502-3568\",\"Email\":\"hcleminson1u@topsy.com\"},{\"Id\":6,\"FirstName\":\"Auroora\",\"LastName\":\"O' Dooley\",\"Phone\":\"255-440-0223\",\"Email\":\"aodooley1t@wsj.com\"},{\"Id\":7,\"FirstName\":\"Karla\",\"LastName\":\"Kinnear\",\"Phone\":\"461-361-0505\",\"Email\":\"kkinnear1s@tripadvisor.com\"},{\"Id\":8,\"FirstName\":\"Isahella\",\"LastName\":\"Zelland\",\"Phone\":\"508-681-1324\",\"Email\":\"izelland1q@unc.edu\"},{\"Id\":9,\"FirstName\":\"Oriana\",\"LastName\":\"Brounfield\",\"Phone\":\"109-537-6331\",\"Email\":\"obrounfield1o@vimeo.com\"},{\"Id\":10,\"FirstName\":\"Whitaker\",\"LastName\":\"Hursthouse\",\"Phone\":\"433-972-7281\",\"Email\":\"whursthouse1n@google.ru\"},{\"Id\":11,\"FirstName\":\"Orin\",\"LastName\":\"Jakubovski\",\"Phone\":\"593-609-4208\",\"Email\":\"ojakubovski1m@livejournal.com\"},{\"Id\":12,\"FirstName\":\"Wittie\",\"LastName\":\"Pedlow\",\"Phone\":\"836-531-3380\",\"Email\":\"wpedlow1l@flickr.com\"},{\"Id\":13,\"FirstName\":\"Ketty\",\"LastName\":\"Comerford\",\"Phone\":\"521-256-8694\",\"Email\":\"kcomerford1j@moonfruit.com\"},{\"Id\":14,\"FirstName\":\"Odella\",\"LastName\":\"Shurrock\",\"Phone\":\"322-611-4364\",\"Email\":\"oshurrock1i@imgur.com\"},{\"Id\":15,\"FirstName\":\"Alden\",\"LastName\":\"Vellden\",\"Phone\":\"280-125-7176\",\"Email\":\"avellden1h@umich.edu\"},{\"Id\":16,\"FirstName\":\"Torrey\",\"LastName\":\"Ricardon\",\"Phone\":\"753-107-1314\",\"Email\":\"tricardon1f@flavors.me\"},{\"Id\":17,\"FirstName\":\"Dalton\",\"LastName\":\"Sinclaire\",\"Phone\":\"913-492-2253\",\"Email\":\"dsinclaire1z@irs.gov\"},{\"Id\":18,\"FirstName\":\"Kristin\",\"LastName\":\"Roddick\",\"Phone\":\"114-900-1773\",\"Email\":\"kroddick1e@house.gov\"},{\"Id\":19,\"FirstName\":\"Tommy\",\"LastName\":\"Click\",\"Phone\":\"687-754-1415\",\"Email\":\"tclick20@omniture.com\"},{\"Id\":20,\"FirstName\":\"Gayla\",\"LastName\":\"Janoch\",\"Phone\":\"337-247-8992\",\"Email\":\"gjanoch23@nps.gov\"},{\"Id\":21,\"FirstName\":\"Miles\",\"LastName\":\"Flockhart\",\"Phone\":\"342-392-8973\",\"Email\":\"mflockhart2p@indiatimes.com\"},{\"Id\":22,\"FirstName\":\"Hall\",\"LastName\":\"Frear\",\"Phone\":\"132-964-3314\",\"Email\":\"hfrear2l@netlog.com\"},{\"Id\":23,\"FirstName\":\"Nobie\",\"LastName\":\"Buddington\",\"Phone\":\"547-457-9086\",\"Email\":\"nbuddington2h@samsung.com\"},{\"Id\":24,\"FirstName\":\"Janelle\",\"LastName\":\"Seppey\",\"Phone\":\"101-659-2330\",\"Email\":\"jseppey2g@feedburner.com\"},{\"Id\":25,\"FirstName\":\"Cynthy\",\"LastName\":\"Boichat\",\"Phone\":\"882-509-2981\",\"Email\":\"cboichat2f@ox.ac.uk\"},{\"Id\":26,\"FirstName\":\"Regan\",\"LastName\":\"Jertz\",\"Phone\":\"131-273-6926\",\"Email\":\"rjertz2e@unc.edu\"},{\"Id\":27,\"FirstName\":\"Veronique\",\"LastName\":\"Legges\",\"Phone\":\"195-654-7566\",\"Email\":\"vlegges2c@wp.com\"},{\"Id\":28,\"FirstName\":\"Stanly\",\"LastName\":\"Starcks\",\"Phone\":\"915-600-0699\",\"Email\":\"sstarcks2b@spotify.com\"},{\"Id\":29,\"FirstName\":\"Adelaida\",\"LastName\":\"Begwell\",\"Phone\":\"892-210-0399\",\"Email\":\"abegwell2a@yellowpages.com\"},{\"Id\":30,\"FirstName\":\"Valene\",\"LastName\":\"Billham\",\"Phone\":\"568-198-5531\",\"Email\":\"vbillham29@themeforest.net\"},{\"Id\":31,\"FirstName\":\"Jenny\",\"LastName\":\"Boote\",\"Phone\":\"491-779-5848\",\"Email\":\"jboote28@multiply.com\"},{\"Id\":32,\"FirstName\":\"Marsiella\",\"LastName\":\"Fulun\",\"Phone\":\"608-762-4403\",\"Email\":\"mfulun27@icio.us\"},{\"Id\":33,\"FirstName\":\"Ashia\",\"LastName\":\"Esh\",\"Phone\":\"671-170-9184\",\"Email\":\"aesh26@sitemeter.com\"},{\"Id\":34,\"FirstName\":\"Noella\",\"LastName\":\"Coslitt\",\"Phone\":\"785-933-3006\",\"Email\":\"ncoslitt25@prweb.com\"},{\"Id\":35,\"FirstName\":\"Carmela\",\"LastName\":\"Clemerson\",\"Phone\":\"435-368-5249\",\"Email\":\"cclemerson24@gizmodo.com\"},{\"Id\":36,\"FirstName\":\"Abdel\",\"LastName\":\"Ponnsett\",\"Phone\":\"919-455-7061\",\"Email\":\"aponnsett22@yolasite.com\"},{\"Id\":37,\"FirstName\":\"Dietrich\",\"LastName\":\"Granville\",\"Phone\":\"756-179-0948\",\"Email\":\"dgranville2q@mlb.com\"},{\"Id\":38,\"FirstName\":\"Charlotte\",\"LastName\":\"Scamadin\",\"Phone\":\"786-924-5038\",\"Email\":\"cscamadin1d@dailymotion.com\"},{\"Id\":39,\"FirstName\":\"Aubert\",\"LastName\":\"Vignal\",\"Phone\":\"305-777-7813\",\"Email\":\"avignal1b@nbcnews.com\"},{\"Id\":40,\"FirstName\":\"Sybyl\",\"LastName\":\"Gasking\",\"Phone\":\"173-535-3632\",\"Email\":\"sgaskingo@ca.gov\"},{\"Id\":41,\"FirstName\":\"Austin\",\"LastName\":\"Hollingby\",\"Phone\":\"847-135-7950\",\"Email\":\"ahollingbyn@diigo.com\"},{\"Id\":42,\"FirstName\":\"Hettie\",\"LastName\":\"Cattenach\",\"Phone\":\"588-104-9281\",\"Email\":\"hcattenachm@ovh.net\"},{\"Id\":43,\"FirstName\":\"Fianna\",\"LastName\":\"Dripps\",\"Phone\":\"765-845-6325\",\"Email\":\"fdrippsl@reverbnation.com\"},{\"Id\":44,\"FirstName\":\"Sax\",\"LastName\":\"Careswell\",\"Phone\":\"387-691-8108\",\"Email\":\"scareswellk@xinhuanet.com\"},{\"Id\":45,\"FirstName\":\"Sula\",\"LastName\":\"MacTeague\",\"Phone\":\"522-631-8457\",\"Email\":\"smacteagueg@deliciousdays.com\"},{\"Id\":46,\"FirstName\":\"Izaak\",\"LastName\":\"Birkenshaw\",\"Phone\":\"637-464-7998\",\"Email\":\"ibirkenshawf@umich.edu\"},{\"Id\":47,\"FirstName\":\"Demetre\",\"LastName\":\"Simeons\",\"Phone\":\"795-678-6253\",\"Email\":\"dsimeonsd@istockphoto.com\"},{\"Id\":48,\"FirstName\":\"Kellen\",\"LastName\":\"Koppke\",\"Phone\":\"154-909-0508\",\"Email\":\"kkoppkec@com.com\"},{\"Id\":49,\"FirstName\":\"Misti\",\"LastName\":\"Dwight\",\"Phone\":\"293-652-2724\",\"Email\":\"mdwightb@usda.gov\"},{\"Id\":50,\"FirstName\":\"Chanda\",\"LastName\":\"Adame\",\"Phone\":\"531-686-6675\",\"Email\":\"cadamea@zimbio.com\"},{\"Id\":51,\"FirstName\":\"Adora\",\"LastName\":\"Albinson\",\"Phone\":\"580-171-5304\",\"Email\":\"aalbinson9@smh.com.au\"},{\"Id\":52,\"FirstName\":\"Philbert\",\"LastName\":\"Canland\",\"Phone\":\"118-968-8333\",\"Email\":\"pcanland8@baidu.com\"},{\"Id\":53,\"FirstName\":\"Terri\",\"LastName\":\"Credland\",\"Phone\":\"277-480-3447\",\"Email\":\"tcredland7@wp.com\"},{\"Id\":54,\"FirstName\":\"Aila\",\"LastName\":\"Fallanche\",\"Phone\":\"142-613-9240\",\"Email\":\"afallanche6@simplemachines.org\"},{\"Id\":55,\"FirstName\":\"Susy\",\"LastName\":\"Breinl\",\"Phone\":\"985-611-5342\",\"Email\":\"sbreinlp@google.es\"},{\"Id\":56,\"FirstName\":\"Caroljean\",\"LastName\":\"Bisgrove\",\"Phone\":\"472-703-3006\",\"Email\":\"cbisgrove1c@gizmodo.com\"},{\"Id\":57,\"FirstName\":\"Eldin\",\"LastName\":\"Stowell\",\"Phone\":\"671-858-6112\",\"Email\":\"estowellq@joomla.org\"},{\"Id\":58,\"FirstName\":\"Porty\",\"LastName\":\"Snookes\",\"Phone\":\"757-479-2113\",\"Email\":\"psnookess@independent.co.uk\"},{\"Id\":59,\"FirstName\":\"Lorelle\",\"LastName\":\"Ingledew\",\"Phone\":\"939-651-9389\",\"Email\":\"lingledew1a@amazon.co.uk\"},{\"Id\":60,\"FirstName\":\"Holly-anne\",\"LastName\":\"Nannini\",\"Phone\":\"756-854-5456\",\"Email\":\"hnannini19@squidoo.com\"},{\"Id\":61,\"FirstName\":\"Charo\",\"LastName\":\"Blazey\",\"Phone\":\"916-101-4919\",\"Email\":\"cblazey18@technorati.com\"},{\"Id\":62,\"FirstName\":\"Angelina\",\"LastName\":\"Tallet\",\"Phone\":\"695-282-9720\",\"Email\":\"atallet16@squarespace.com\"},{\"Id\":63,\"FirstName\":\"Carr\",\"LastName\":\"Westney\",\"Phone\":\"108-700-4443\",\"Email\":\"cwestney15@qq.com\"},{\"Id\":64,\"FirstName\":\"Tally\",\"LastName\":\"Salzen\",\"Phone\":\"737-565-4507\",\"Email\":\"tsalzen14@umich.edu\"},{\"Id\":65,\"FirstName\":\"Melody\",\"LastName\":\"Binyon\",\"Phone\":\"160-690-1149\",\"Email\":\"mbinyon13@earthlink.net\"},{\"Id\":66,\"FirstName\":\"Lloyd\",\"LastName\":\"Jickells\",\"Phone\":\"987-139-5281\",\"Email\":\"ljickells12@springer.com\"},{\"Id\":67,\"FirstName\":\"Meredeth\",\"LastName\":\"MacCostye\",\"Phone\":\"210-463-5830\",\"Email\":\"mmaccostye10@moonfruit.com\"},{\"Id\":68,\"FirstName\":\"Gretel\",\"LastName\":\"Mersh\",\"Phone\":\"126-272-1610\",\"Email\":\"gmershz@irs.gov\"},{\"Id\":69,\"FirstName\":\"Neron\",\"LastName\":\"Winterflood\",\"Phone\":\"855-769-8818\",\"Email\":\"nwinterfloody@tripod.com\"},{\"Id\":70,\"FirstName\":\"Cornall\",\"LastName\":\"Morgon\",\"Phone\":\"556-825-2071\",\"Email\":\"cmorgonw@scientificamerican.com\"},{\"Id\":71,\"FirstName\":\"Bradford\",\"LastName\":\"Larderot\",\"Phone\":\"934-360-9692\",\"Email\":\"blarderotv@dropbox.com\"},{\"Id\":72,\"FirstName\":\"Ashleigh\",\"LastName\":\"Beggi\",\"Phone\":\"486-407-7149\",\"Email\":\"abeggiu@cafepress.com\"},{\"Id\":73,\"FirstName\":\"Gerrie\",\"LastName\":\"Leatham\",\"Phone\":\"904-474-1608\",\"Email\":\"gleathamt@skyrock.com\"},{\"Id\":74,\"FirstName\":\"Giovanni\",\"LastName\":\"Marcham\",\"Phone\":\"334-983-8105\",\"Email\":\"gmarchamr@uiuc.edu\"},{\"Id\":75,\"FirstName\":\"Giustino\",\"LastName\":\"Tinkler\",\"Phone\":\"736-844-6719\",\"Email\":\"gtinkler2r@jimdo.com\"}],\"AuthorBook\":[{\"AuthorId\":75,\"BookId\":1},{\"AuthorId\":13,\"BookId\":3},{\"AuthorId\":4,\"BookId\":4},{\"AuthorId\":35,\"BookId\":4},{\"AuthorId\":40,\"BookId\":4},{\"AuthorId\":47,\"BookId\":4},{\"AuthorId\":69,\"BookId\":5},{\"AuthorId\":11,\"BookId\":6},{\"AuthorId\":13,\"BookId\":6},{\"AuthorId\":58,\"BookId\":6},{\"AuthorId\":17,\"BookId\":7},{\"AuthorId\":28,\"BookId\":7},{\"AuthorId\":42,\"BookId\":7},{\"AuthorId\":75,\"BookId\":7},{\"AuthorId\":21,\"BookId\":8},{\"AuthorId\":25,\"BookId\":8},{\"AuthorId\":57,\"BookId\":8},{\"AuthorId\":26,\"BookId\":9},{\"AuthorId\":43,\"BookId\":9},{\"AuthorId\":67,\"BookId\":9},{\"AuthorId\":35,\"BookId\":10},{\"AuthorId\":49,\"BookId\":11},{\"AuthorId\":25,\"BookId\":13},{\"AuthorId\":71,\"BookId\":13},{\"AuthorId\":44,\"BookId\":14},{\"AuthorId\":53,\"BookId\":14},{\"AuthorId\":7,\"BookId\":15},{\"AuthorId\":27,\"BookId\":16},{\"AuthorId\":30,\"BookId\":16},{\"AuthorId\":9,\"BookId\":17},{\"AuthorId\":65,\"BookId\":17},{\"AuthorId\":11,\"BookId\":18},{\"AuthorId\":69,\"BookId\":19},{\"AuthorId\":42,\"BookId\":20},{\"AuthorId\":24,\"BookId\":21},{\"AuthorId\":33,\"BookId\":21},{\"AuthorId\":58,\"BookId\":21},{\"AuthorId\":62,\"BookId\":21},{\"AuthorId\":73,\"BookId\":21},{\"AuthorId\":48,\"BookId\":22},{\"AuthorId\":68,\"BookId\":22},{\"AuthorId\":23,\"BookId\":23},{\"AuthorId\":25,\"BookId\":23},{\"AuthorId\":54,\"BookId\":23},{\"AuthorId\":1,\"BookId\":24},{\"AuthorId\":10,\"BookId\":24},{\"AuthorId\":25,\"BookId\":24},{\"AuthorId\":29,\"BookId\":24},{\"AuthorId\":35,\"BookId\":24},{\"AuthorId\":53,\"BookId\":25},{\"AuthorId\":39,\"BookId\":26},{\"AuthorId\":41,\"BookId\":26},{\"AuthorId\":24,\"BookId\":27},{\"AuthorId\":12,\"BookId\":28},{\"AuthorId\":27,\"BookId\":28},{\"AuthorId\":36,\"BookId\":28},{\"AuthorId\":45,\"BookId\":28},{\"AuthorId\":37,\"BookId\":29},{\"AuthorId\":38,\"BookId\":29},{\"AuthorId\":5,\"BookId\":30},{\"AuthorId\":14,\"BookId\":30},{\"AuthorId\":16,\"BookId\":30},{\"AuthorId\":19,\"BookId\":30},{\"AuthorId\":64,\"BookId\":30},{\"AuthorId\":62,\"BookId\":31},{\"AuthorId\":33,\"BookId\":32},{\"AuthorId\":9,\"BookId\":33},{\"AuthorId\":28,\"BookId\":33},{\"AuthorId\":38,\"BookId\":33},{\"AuthorId\":40,\"BookId\":33},{\"AuthorId\":72,\"BookId\":33},{\"AuthorId\":1,\"BookId\":34},{\"AuthorId\":20,\"BookId\":34},{\"AuthorId\":57,\"BookId\":34},{\"AuthorId\":71,\"BookId\":34},{\"AuthorId\":56,\"BookId\":38},{\"AuthorId\":8,\"BookId\":39},{\"AuthorId\":23,\"BookId\":39},{\"AuthorId\":19,\"BookId\":40},{\"AuthorId\":68,\"BookId\":40},{\"AuthorId\":70,\"BookId\":40},{\"AuthorId\":10,\"BookId\":41},{\"AuthorId\":19,\"BookId\":41},{\"AuthorId\":11,\"BookId\":42},{\"AuthorId\":12,\"BookId\":42},{\"AuthorId\":21,\"BookId\":42},{\"AuthorId\":29,\"BookId\":42},{\"AuthorId\":47,\"BookId\":42},{\"AuthorId\":36,\"BookId\":43},{\"AuthorId\":43,\"BookId\":43},{\"AuthorId\":57,\"BookId\":43},{\"AuthorId\":16,\"BookId\":44},{\"AuthorId\":52,\"BookId\":44},{\"AuthorId\":61,\"BookId\":44},{\"AuthorId\":65,\"BookId\":44},{\"AuthorId\":16,\"BookId\":45},{\"AuthorId\":68,\"BookId\":45},{\"AuthorId\":3,\"BookId\":46},{\"AuthorId\":43,\"BookId\":46},{\"AuthorId\":66,\"BookId\":47},{\"AuthorId\":71,\"BookId\":49},{\"AuthorId\":72,\"BookId\":49},{\"AuthorId\":73,\"BookId\":49},{\"AuthorId\":21,\"BookId\":50},{\"AuthorId\":34,\"BookId\":50},{\"AuthorId\":39,\"BookId\":50},{\"AuthorId\":14,\"BookId\":51},{\"AuthorId\":22,\"BookId\":51},{\"AuthorId\":34,\"BookId\":51},{\"AuthorId\":71,\"BookId\":51},{\"AuthorId\":6,\"BookId\":52},{\"AuthorId\":12,\"BookId\":52},{\"AuthorId\":46,\"BookId\":52},{\"AuthorId\":61,\"BookId\":53},{\"AuthorId\":20,\"BookId\":54},{\"AuthorId\":29,\"BookId\":54},{\"AuthorId\":74,\"BookId\":54},{\"AuthorId\":9,\"BookId\":55},{\"AuthorId\":31,\"BookId\":55},{\"AuthorId\":4,\"BookId\":56},{\"AuthorId\":67,\"BookId\":56},{\"AuthorId\":2,\"BookId\":57},{\"AuthorId\":33,\"BookId\":57},{\"AuthorId\":60,\"BookId\":57},{\"AuthorId\":32,\"BookId\":58},{\"AuthorId\":47,\"BookId\":58},{\"AuthorId\":51,\"BookId\":59},{\"AuthorId\":15,\"BookId\":60},{\"AuthorId\":18,\"BookId\":61},{\"AuthorId\":19,\"BookId\":61},{\"AuthorId\":4,\"BookId\":62},{\"AuthorId\":34,\"BookId\":62},{\"AuthorId\":72,\"BookId\":63},{\"AuthorId\":5,\"BookId\":64},{\"AuthorId\":33,\"BookId\":64},{\"AuthorId\":60,\"BookId\":64},{\"AuthorId\":62,\"BookId\":64},{\"AuthorId\":11,\"BookId\":65},{\"AuthorId\":48,\"BookId\":65},{\"AuthorId\":22,\"BookId\":67},{\"AuthorId\":55,\"BookId\":67},{\"AuthorId\":62,\"BookId\":67},{\"AuthorId\":10,\"BookId\":69},{\"AuthorId\":18,\"BookId\":69},{\"AuthorId\":50,\"BookId\":69},{\"AuthorId\":54,\"BookId\":69},{\"AuthorId\":55,\"BookId\":69},{\"AuthorId\":60,\"BookId\":69},{\"AuthorId\":59,\"BookId\":70},{\"AuthorId\":63,\"BookId\":70}]}";

        var datasets = JsonConvert.DeserializeObject<Dictionary<string, IEnumerable<JObject>>>(datasetsJson);

        foreach (var dataset in datasets)
        {
            var entityType = GetType(dataset.Key);
            var entities = dataset.Value
                .Select(j => j.ToObject(entityType))
                .ToArray();

            context.AddRange(entities);
        }

        context.SaveChanges();
    }

    private static Type GetType(string modelName)
    {
        var modelType = CurrentAssembly
            .GetTypes()
            .FirstOrDefault(t => t.Name == modelName);

        Assert.IsNotNull(modelType, $"{modelName} model not found!");

        return modelType;
    }

    private static IServiceProvider ConfigureServices<TContext>(string databaseName)
        where TContext : DbContext
    {
        var services = ConfigureDbContext<TContext>(databaseName);

        var context = services.GetService<TContext>();

        try
        {
            context.Model.GetEntityTypes();
        }
        catch (InvalidOperationException ex) when (ex.Source == "Microsoft.EntityFrameworkCore.Proxies")
        {
            services = ConfigureDbContext<TContext>(databaseName, useLazyLoading: true);
        }

        return services;
    }

    private static IServiceProvider ConfigureDbContext<TContext>(string databaseName, bool useLazyLoading = false)
        where TContext : DbContext
    {
        var services = new ServiceCollection()
          .AddDbContext<TContext>(t => t
          .UseInMemoryDatabase(Guid.NewGuid().ToString())
          );

        var serviceProvider = services.BuildServiceProvider();
        return serviceProvider;
    }
}